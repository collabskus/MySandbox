name: Build, Test, and Release

on:
  push:
    branches:
      - master

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_NAME: 'MySandbox'
  CONSOLE_PROJECT: 'MySandbox.Console/MySandbox.Console.csproj'
  TEST_PROJECT: 'MySandbox.Tests/MySandbox.Tests.csproj'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test ${{ env.TEST_PROJECT }} --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: '**/test-results.trx'

  publish-binaries:
    name: Publish for ${{ matrix.platform }}
    needs: build-and-test
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          # Windows builds
          - platform: 'win-x64'
            os: 'windows-latest'
            output_name: 'MySandbox-win-x64.exe'
          - platform: 'win-x86'
            os: 'windows-latest'
            output_name: 'MySandbox-win-x86.exe'
          - platform: 'win-arm64'
            os: 'windows-latest'
            output_name: 'MySandbox-win-arm64.exe'
          
          # Linux builds
          - platform: 'linux-x64'
            os: 'ubuntu-latest'
            output_name: 'MySandbox-linux-x64'
          - platform: 'linux-arm'
            os: 'ubuntu-latest'
            output_name: 'MySandbox-linux-arm'
          - platform: 'linux-arm64'
            os: 'ubuntu-latest'
            output_name: 'MySandbox-linux-arm64'
          - platform: 'linux-musl-x64'
            os: 'ubuntu-latest'
            output_name: 'MySandbox-linux-musl-x64'
          - platform: 'linux-musl-arm64'
            os: 'ubuntu-latest'
            output_name: 'MySandbox-linux-musl-arm64'
          
          # macOS builds
          - platform: 'osx-x64'
            os: 'macos-latest'
            output_name: 'MySandbox-osx-x64'
          - platform: 'osx-arm64'
            os: 'macos-latest'
            output_name: 'MySandbox-osx-arm64'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish self-contained binary
        shell: bash
        run: |
          dotnet publish ${{ env.CONSOLE_PROJECT }} \
            --configuration Release \
            --runtime ${{ matrix.platform }} \
            --self-contained true \
            --output ./publish/${{ matrix.platform }} \
            -p:PublishSingleFile=true \
            -p:PublishTrimmed=false \
            -p:EnableCompressionInSingleFile=true \
            -p:DebugType=None \
            -p:DebugSymbols=false

      - name: Create archive (Windows)
        if: startsWith(matrix.platform, 'win-')
        shell: pwsh
        run: |
          $outputPath = "./publish/${{ matrix.platform }}"
          $archiveName = "MySandbox-${{ matrix.platform }}.zip"
          
          # Include the executable and appsettings.json
          Compress-Archive -Path "$outputPath/*" -DestinationPath $archiveName -Force

      - name: Create archive (Unix)
        if: "!startsWith(matrix.platform, 'win-')"
        run: |
          cd ./publish/${{ matrix.platform }}
          
          # Make executable if it's not Windows
          chmod +x MySandbox.Console 2>/dev/null || true
          
          # Create tar.gz archive
          tar -czf ../../MySandbox-${{ matrix.platform }}.tar.gz *

      - name: Upload Windows artifacts
        if: startsWith(matrix.platform, 'win-')
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.platform }}
          path: MySandbox-${{ matrix.platform }}.zip
          retention-days: 90

      - name: Upload Unix artifacts
        if: "!startsWith(matrix.platform, 'win-')"
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.platform }}
          path: MySandbox-${{ matrix.platform }}.tar.gz
          retention-days: 90

  create-release:
    name: Create Release
    needs: publish-binaries
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display artifact structure
        run: ls -R ./artifacts

      - name: Generate build timestamp
        id: timestamp
        run: echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ steps.timestamp.outputs.timestamp }}
          name: Build ${{ steps.timestamp.outputs.timestamp }}
          body: |
            Automated build from commit ${{ github.sha }}
            
            **Commit Message:** ${{ github.event.head_commit.message }}
            **Author:** ${{ github.event.head_commit.author.name }}
            **Date:** ${{ github.event.head_commit.timestamp }}
            
            ## Platforms
            
            ### Windows
            - win-x64 (64-bit)
            - win-x86 (32-bit)
            - win-arm64 (ARM 64-bit)
            
            ### Linux
            - linux-x64 (64-bit)
            - linux-arm (ARM 32-bit)
            - linux-arm64 (ARM 64-bit)
            - linux-musl-x64 (Alpine Linux 64-bit)
            - linux-musl-arm64 (Alpine Linux ARM 64-bit)
            
            ### macOS
            - osx-x64 (Intel 64-bit)
            - osx-arm64 (Apple Silicon)
            
            All binaries are self-contained and do not require .NET runtime installation.
          files: |
            ./artifacts/binary-win-x64/*.zip
            ./artifacts/binary-win-x86/*.zip
            ./artifacts/binary-win-arm64/*.zip
            ./artifacts/binary-linux-x64/*.tar.gz
            ./artifacts/binary-linux-arm/*.tar.gz
            ./artifacts/binary-linux-arm64/*.tar.gz
            ./artifacts/binary-linux-musl-x64/*.tar.gz
            ./artifacts/binary-linux-musl-arm64/*.tar.gz
            ./artifacts/binary-osx-x64/*.tar.gz
            ./artifacts/binary-osx-arm64/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Build Summary
    needs: [build-and-test, publish-binaries, create-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "- Build and Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Publish Binaries: ${{ needs.publish-binaries.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Create Release: ${{ needs.create-release.result }}" >> $GITHUB_STEP_SUMMARY
